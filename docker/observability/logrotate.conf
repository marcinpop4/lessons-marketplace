# Logrotate configuration for lessons-marketplace application logs
# This configuration uses the 'copytruncate' strategy which is compatible
# with log shipping tools like Promtail that keep file descriptors open.

# Application log files - unified configuration for all log types
/var/log/app/*.log {
    # Rotate daily or when size exceeds 20MB
    daily
    size 20M
    
    # Keep 14 days of logs
    rotate 14
    
    # Use copytruncate to avoid breaking Promtail file descriptors
    # This copies the log file then truncates the original to 0 bytes
    # keeping the same inode, so Promtail continues reading seamlessly
    copytruncate
    
    # Compress rotated files (but not immediately)
    compress
    delaycompress
    
    # Don't error if log file is missing
    missingok
    
    # Don't rotate empty files
    notifempty
    
    # Create new log files with specific permissions
    create 644 root root
    
    # Only run postrotate script once for all files
    sharedscripts
    
    # Log that rotation completed
    postrotate
        echo "$(date): Log rotation completed for lessons-marketplace" >> /var/log/logrotate.log || true
    endscript
} 